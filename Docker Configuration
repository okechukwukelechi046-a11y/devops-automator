# Multi-stage build for DevOps Automator
FROM python:3.9-slim AS builder

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    gnupg \
    lsb-release \
    gcc \
    g++ \
    make \
    git \
    ssh \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Install AWS CLI
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" \
    && unzip awscliv2.zip \
    && ./aws/install \
    && rm -rf awscliv2.zip ./aws

# Install kubectl
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
    && chmod +x kubectl \
    && mv kubectl /usr/local/bin/

# Install Terraform
RUN curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" > /etc/apt/sources.list.d/hashicorp.list \
    && apt-get update && apt-get install -y terraform \
    && rm -rf /var/lib/apt/lists/*

# Install Helm
RUN curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# Copy requirements
COPY requirements.txt .
COPY requirements-dev.txt .

# Install Python dependencies
RUN pip install --user --no-cache-dir -r requirements.txt

# Copy application
COPY src/ ./src/
COPY templates/ ./templates/
COPY scripts/ ./scripts/
COPY examples/ ./examples/

# Production stage
FROM python:3.9-slim

WORKDIR /app

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    curl \
    gnupg \
    git \
    ssh \
    unzip \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copy installed tools from builder
COPY --from=builder /usr/local/bin/aws /usr/local/bin/aws
COPY --from=builder /usr/local/bin/kubectl /usr/local/bin/kubectl
COPY --from=builder /usr/bin/terraform /usr/bin/terraform
COPY --from=builder /usr/local/bin/helm /usr/local/bin/helm

# Copy Python dependencies from builder
COPY --from=builder /root/.local /root/.local

# Copy application
COPY --from=builder /app .

# Create non-root user
RUN useradd --create-home devops \
    && mkdir -p /home/devops/.aws \
    && mkdir -p /home/devops/.kube \
    && chown -R devops:devops /home/devops \
    && chown -R devops:devops /app

USER devops

# Add .local/bin to PATH
ENV PATH=/home/devops/.local/bin:$PATH

# Set Python path
ENV PYTHONPATH=/app:$PYTHONPATH

# Create configuration directories
RUN mkdir -p /home/devops/.devops-automator \
    && mkdir -p /home/devops/.devops-automator/state \
    && mkdir -p /home/devops/.devops-automator/templates

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD python -c "import sys; sys.exit(0)"

# Default command
ENTRYPOINT ["python", "-m", "src.cli.main"]

# Build and run instructions
# docker build -t devops-automator .
# docker run -it --rm \
#   -v ~/.aws:/home/devops/.aws \
#   -v ~/.kube:/home/devops/.kube \
#   -v $(pwd)/projects:/home/devops/projects \
#   devops-automator --help
